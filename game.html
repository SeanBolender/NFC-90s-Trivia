<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>90s NFC Hunt - Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background-color: #f0f8ff; color: #1e3a6a; }
    .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.12); }
    h1 { margin-bottom: 4px; }
    h2 { color: #008080; margin-top: 6px; }
    .question-box { margin: 25px 0; padding: 20px; border: 3px dashed #FFD700; border-radius: 8px; background-color: #fff9c4; text-align:left; }
    .choices { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .choice-btn { text-align:left; padding:10px 12px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; font-size:15px; }
    .choice-btn:focus { outline:3px solid rgba(0,128,128,0.2); }
    .error { color: #b91c1c; font-weight: bold; }
    #debug-info { margin-top: 24px; font-size: 12px; color: #777; border-top: 1px dashed #ccc; padding-top: 10px; text-align: left; white-space: pre-wrap; }
    a.button-like { display:inline-block; margin-top:12px; padding:8px 14px; background:#1e90ff; color:#fff; border-radius:8px; text-decoration:none; }
  </style>
</head>
<body>
  <div class="container" role="main" aria-live="polite">
    <h1 id="game-title">90s Time Warp Hunt</h1>
    <div id="game-content">Loading game...</div>
  </div>

  <div id="debug-info" aria-hidden="true"></div>

<script>
/*
 Multiple-choice game.html
 - Renders 4-choice buttons per question
 - Logs selection via fetch POST to POST_URL (JSON)
 - Advances immediately to show clue (no correctness feedback)
 - Reads/writes state to localStorage and cookie fallback
 - Safe DOM insertion via textContent
*/

// <<< SET THIS TO YOUR APPS SCRIPT /exec URL AFTER DEPLOYMENT >>>
const POST_URL = "https://script.google.com/macros/s/AKfycbzDTWJUAi5Ix9hZoeSOpwNAH_eyS1x1z0se0VDu8wUGP5cDLJ6OjXA2iOy3TGg8odZ4/exec";

const gameData = {
  sequence: ['Q1','Q2','Q3','Q4','Q5','Q6','Q7','Q8','Q9','Q10'],
  Q0: { clue: "Find the first NFC chip on the NSYNC Cutout." },
  Q1: {
    title: "Q1: üé∂ Pop Music",
    question: "Which group, known for hits like 'Bye Bye Bye,' was founded in 1995 but had its name taken from a famous attraction at Disney World?",
    correctAnswer: "NSYNC",
    choices: ["BACKSTREET BOYS", "NSYNC", "98 DEGREES", "BOYS II MEN"],
    clue: "Answer recorded! Your next challenge is found by the Game Boy.",
    nextTag: "Q2"
  },
  Q2: {
    title: "Q2: üïπÔ∏è Gaming",
    question: "What highly addictive puzzle game, invented in the 80s, was included with the purchase of every original Game Boy console?",
    correctAnswer: "TETRIS",
    choices: ["TETRIS", "PUZZLE BOBBLE", "SNAKE", "SOLITAIRE"],
    clue: "Answer recorded! The next chip is taped inside the Michael Jordan TV Guide.",
    nextTag: "Q3"
  },
  Q3: {
    title: "Q3: üèÄ Sports",
    question: "What iconic number did Michael Jordan wear for most of his career with the Chicago Bulls, and when he played on the 1992 Dream Team?",
    correctAnswer: "23",
    choices: ["24", "23", "32", "45"],
    clue: "Slam dunk, answer recorded!! Your next clue is near the lovable nerd's favorite cheese snack.",
    nextTag: "Q4"
  },
  Q4: {
    title: "Q4: üì∫ TV Sitcom",
    question: "What popular catchphrase, often followed by a backward shrug, was constantly repeated by the lovable nerd Steve Urkel on the show Family Matters?",
    correctAnswer: "DID I DO THAT?",
    choices: ["WHATCHOO TALKIN' 'BOUT?", "DID I DO THAT?", "HOW YOU DOIN'?", "I'LL BE BACK"],
    clue: "Answer recorded! Beam over to the captain's chair‚Äîthe biggest ship is calling for Riker.",
    nextTag: "Q5"
  },
  Q5: {
    title: "Q5: üññ Sci-Fi Trek",
    question: "STAR TREK: TNG: What is the full name of Captain Picard's first officer, who served for all seven seasons of The Next Generation?",
    correctAnswer: "WILLIAM T. RIKER",
    choices: ["WILLIAM RIKER", "WILLIAM T. RIKER", "WILL RIKER", "WILLIAM R. RIKER"],
    clue: "Engage! Look for the place where toys first came to life‚Äîthe cowboy doll's foot.",
    nextTag: "Q6"
  },
  Q6: {
    title: "Q6: üé¨ Animated Film",
    question: "What was the name of the first-ever feature-length film created entirely using computer-generated imagery (CGI)?",
    correctAnswer: "TOY STORY",
    choices: ["TOY STORY", "TRON", "TOY SOLDIERS", "A BUG'S LIFE"],
    clue: "To infinity and beyond! Now, find the spot where a famous Spanish dance became a worldwide hit on a boombox.",
    nextTag: "Q7"
  },
  Q7: {
    title: "Q7: üíÉ Dance Craze",
    question: "What Spanish one-hit wonder was remixed by the Bayside Boys and became a global dance craze in 1996, spending 14 weeks at #1?",
    correctAnswer: "MACARENA",
    choices: ["LA MACARENA", "MACARENA", "BASURA", "DESPACITO"],
    clue: "Heeeeeyyy Macarena! Find the book by R.L. Stine that details a buzzing fear.",
    nextTag: "Q8"
  },
  Q8: {
    title: "Q8: üìö Children's Horror",
    question: "The book Why I‚Äôm Afraid of Bees belongs to the famous children‚Äôs horror series written by what author?",
    correctAnswer: "R.L. STINE",
    choices: ["R.L. STINE", "CHRISTOPHER PAOLINI", "J.K. ROWLING", "R.L. STEINER"],
    clue: "Be warned! The next question is waiting on the back of the DVD player.",
    nextTag: "Q9"
  },
  Q9: {
    title: "Q9: üìÄ Home Video Tech",
    question: "In 1998, a new format war began when the superior DVD format won out over its competitor, which was backed by Toshiba. What was the name of the losing format?",
    correctAnswer: "DIVX",
    choices: ["HD DVD", "DIVX", "VISTA", "VHS++"],
    clue: "Movie night success! For the finale, find the subtle red object in the next room.",
    nextTag: "Q10"
  },
  Q10: {
    title: "Q10: üëª Film Finale",
    question: "The shocking final reveal and famous line ('I see dead people') belong to which psychological thriller film?",
    correctAnswer: "THE SIXTH SENSE",
    choices: ["SEVENTH HEAVEN", "THE SIXTH SENSE", "SIX SENSES", "UNBREAKABLE"],
    clue: "üéâ CONGRATULATIONS! The code is 90SBOOM. Go to the treasure chest for your grand prize!",
    nextTag: "WIN"
  },
  WIN: {
    title: "üéâ Hunt Complete!",
    content: "You mastered the 90s Time Warp! Pick out your prize. Watch the leaderboard to see who did the best!"
  }
};

// ----------------- storage helpers -----------------
function encodeCookieName(name) { return encodeURIComponent(name); }
function decodeCookieValue(val) { try { return decodeURIComponent(val); } catch (e) { return val; } }

function getCookie(name) {
  if (!name) return null;
  const encodedName = encodeCookieName(name) + "=";
  const parts = document.cookie.split(';');
  for (let i = 0; i < parts.length; i++) {
    let c = parts[i].trim();
    if (c.indexOf(encodedName) === 0) {
      return decodeCookieValue(c.substring(encodedName.length));
    }
  }
  return null;
}

function setCookie(name, value, days) {
  if (!name) return;
  const n = encodeCookieName(name);
  const v = encodeURIComponent(value || "");
  let expires = "";
  if (typeof days === "number" && days > 0) {
    const date = new Date();
    date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = `${n}=${v}${expires}; path=/; SameSite=Lax; Secure`;
}

// ----------------- utility functions -----------------
function debug(msg) {
  const el = document.getElementById('debug-info');
  if (!el) return;
  el.textContent += msg + "\n";
}

// ----------------- read state (localStorage preferred) -----------------
const urlParams = new URLSearchParams(window.location.search);
const tagID = urlParams.get('q');

let teamName = null;
let currentStep = null;

try {
  teamName = localStorage.getItem('teamName') || null;
  currentStep = localStorage.getItem('currentStep') || null;
} catch (e) { teamName = null; currentStep = null; }

if (!teamName) teamName = getCookie('teamName');
if (!currentStep) currentStep = getCookie('currentStep') || 'Q0';
if (!currentStep) currentStep = 'Q0';

// ----------------- guard if no teamName -----------------
const gameContent = document.getElementById('game-content');

if (!teamName) {
  gameContent.innerHTML = "";
  const p = document.createElement('p');
  p.className = "error";
  p.textContent = "No team name found. Please start from the Start page to register your team.";
  gameContent.appendChild(p);

  const back = document.createElement('a');
  back.href = "start.html";
  back.className = "button-like";
  back.textContent = "Go to Start";
  gameContent.appendChild(back);

  const note = document.createElement('p');
  note.style.marginTop = '12px';
  note.style.fontSize = '0.95em';
  note.textContent = "If you followed a direct link, the start page may not have set your team. Try the Start page.";
  gameContent.appendChild(note);

  debug("No team name; stopping execution.");
  throw new Error("No team name");
}

// ----------------- core functions -----------------
function saveState(step) {
  try { localStorage.setItem('currentStep', step); } catch (e) {}
  setCookie('currentStep', step, 7);
  currentStep = step;
  debug(`State saved: currentStep=${step}`);
}

async function logChoice(questionID, selectedChoice, attempt = 0) {
  // Build the payload to match your Apps Script headers
  const payload = {
    Team: teamName,
    Question: questionID,
    Choice: selectedChoice,
    // optional client-side timestamp (server also records its own)
    ClientTimestamp: new Date().toISOString(),
    // helpful debugging fields
    ClientUA: (typeof navigator !== 'undefined' && navigator.userAgent) ? navigator.userAgent : '',
    ClientOrigin: (typeof location !== 'undefined' && location.origin) ? location.origin : ''
  };

  try {
    const resp = await fetch(POST_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(() => '<no body>');
      throw new Error(`Server returned ${resp.status}: ${txt}`);
    }

    // parse response if JSON
    try {
      const j = await resp.json();
      debug(`Logged ${questionID} response: ${JSON.stringify(j)}`);
    } catch (err) {
      debug(`Logged ${questionID}: server returned non-JSON or no body`);
    }
  } catch (err) {
    debug(`Logging failed (attempt ${attempt}): ${String(err)}`);
    // simple retry once after 1s
    if (attempt < 1) {
      await new Promise(r => setTimeout(r, 1000));
      return logChoice(questionID, selectedChoice, attempt + 1);
    }
    // If still failing, queue locally for later flush
    try {
      const queue = JSON.parse(localStorage.getItem('logQueue') || '[]');
      queue.push(payload);
      localStorage.setItem('logQueue', JSON.stringify(queue));
      debug('Saved log to local queue for retry later');
    } catch (e) {
      debug('Failed to save to local queue: ' + String(e));
    }
  }
}

/* Optionally add a flush function to send queued logs when network returns */
async function flushLogQueue() {
  try {
    const queue = JSON.parse(localStorage.getItem('logQueue') || '[]');
    if (!Array.isArray(queue) || queue.length === 0) return;
    for (let i = 0; i < queue.length; i++) {
      const item = queue[i];
      try {
        const resp = await fetch(POST_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item)
        });
        if (resp.ok) {
          // remove first element and continue
          queue.shift();
          localStorage.setItem('logQueue', JSON.stringify(queue));
          i--; // adjust index because we removed current item
        } else {
          break; // stop on server error
        }
      } catch (_) {
        break; // stop on network error
      }
    }
  } catch (e) {
    debug('flushLogQueue error: ' + String(e));
  }
}

// When a choice is selected: log it, advance state, show clue (no correctness feedback)
function handleChoice(questionID, selectedChoice) {
  // Fire-and-forget logging (don't block UI)
  logChoice(questionID, selectedChoice).catch(()=>{});
  const nextTag = gameData[questionID] && gameData[questionID].nextTag;
  const nextClue = gameData[questionID] && gameData[questionID].clue;
  if (nextTag) saveState(nextTag);
  showClueAndNext(nextClue);
}

// Render the clue + a restart link
function showClueAndNext(clue) {
  const container = document.getElementById('game-content');
  container.innerHTML = "";

  const title = document.createElement('h2');
  title.textContent = "Clue";
  container.appendChild(title);

  const c = document.createElement('p');
  c.textContent = clue || '';
  c.style.fontWeight = '600';
  container.appendChild(c);

  const continueNote = document.createElement('p');
  continueNote.style.marginTop = '8px';
  continueNote.textContent = "Proceed to scan the next tag in the physical location.";
  container.appendChild(continueNote);

  const restart = document.createElement('a');
  restart.href = "start.html";
  restart.className = "button-like";
  restart.textContent = "Restart / New Team";
  container.appendChild(restart);
}

// Render question with multiple choice buttons
function renderQuestion(questionID) {
  const q = gameData[questionID];
  if (!q) {
    const container = document.getElementById('game-content');
    container.innerHTML = "";
    const p = document.createElement('p');
    p.textContent = "Question not found.";
    container.appendChild(p);
    return;
  }

  const container = document.getElementById('game-content');
  container.innerHTML = "";

  const title = document.createElement('h2');
  title.textContent = q.title || questionID;
  container.appendChild(title);

  const box = document.createElement('div');
  box.className = 'question-box';

  const prompt = document.createElement('p');
  prompt.textContent = q.question || "";
  box.appendChild(prompt);

  const choicesDiv = document.createElement('div');
  choicesDiv.className = 'choices';

  const choices = Array.isArray(q.choices) ? q.choices.slice(0,4) : [];
  while (choices.length < 4) choices.push('');

  choices.forEach((choiceText, idx) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'choice-btn';
    btn.setAttribute('aria-label', `Choice ${idx+1}`);
    btn.textContent = choiceText || `Option ${idx+1}`;
    btn.addEventListener('click', function () {
      const btns = choicesDiv.querySelectorAll('button');
      btns.forEach(b => b.disabled = true);
      handleChoice(questionID, choiceText || `Option ${idx+1}`);
    });
    choicesDiv.appendChild(btn);
  });

  box.appendChild(choicesDiv);
  container.appendChild(box);
}

// If user navigated with a tag param, handle it
function handleTag(tag) {
  if (!tag) {
    const container = document.getElementById('game-content');
    container.innerHTML = "";
    const teamP = document.createElement('p');
    teamP.textContent = `Team: ${teamName}`;
    teamP.style.fontWeight = '600';
    container.appendChild(teamP);

    if (currentStep === 'Q0') {
      const p = document.createElement('p');
      p.textContent = gameData.Q0.clue;
      container.appendChild(p);
    } else if (currentStep === 'WIN') {
      const h = document.createElement('h2');
      h.textContent = gameData.WIN.title;
      container.appendChild(h);
      const c = document.createElement('p');
      c.textContent = gameData.WIN.content;
      container.appendChild(c);
    } else {
      const note = document.createElement('p');
      note.textContent = `You are currently at ${currentStep}. Scan the next tag to answer the next question.`;
      container.appendChild(note);
    }

    const restart = document.createElement('a');
    restart.href = "start.html";
    restart.className = "button-like";
    restart.textContent = "Restart / New Team";
    container.appendChild(restart);
    return;
  }

  const normalizedTag = String(tag).toUpperCase();

  if (normalizedTag === 'WIN') {
    const container = document.getElementById('game-content');
    container.innerHTML = "";
    const h = document.createElement('h2');
    h.textContent = gameData.WIN.title;
    container.appendChild(h);
    const c = document.createElement('p');
    c.textContent = gameData.WIN.content;
    container.appendChild(c);
    saveState('WIN');
    return;
  }

  // Determine expectedNext tag: currentStep stores the tag the team should scan next
  let expectedNext;
  if (currentStep === 'Q0') {
    expectedNext = gameData.sequence[0]; // Q1
  } else if (currentStep === 'WIN') {
    expectedNext = 'WIN';
  } else {
    expectedNext = currentStep;
  }

  if (normalizedTag === expectedNext) {
    renderQuestion(normalizedTag);
  } else {
    const container = document.getElementById('game-content');
    container.innerHTML = "";
    const p = document.createElement('p');
    p.className = 'error';
    p.textContent = `Scanned tag (${normalizedTag}) is not the expected next tag for your team. Expected: ${expectedNext}.`;
    container.appendChild(p);

    const hint = document.createElement('p');
    hint.textContent = "If you believe this is an error, check with the game host or restart from the Start page.";
    container.appendChild(hint);

    const restart = document.createElement('a');
    restart.href = "start.html";
    restart.className = "button-like";
    restart.textContent = "Restart / New Team";
    container.appendChild(restart);
  }
}

// initialize
(function init() {
  debug(`Init: team=${teamName} currentStep=${currentStep} tagParam=${tagID || '(none)'}`);
  handleTag(tagID);
})();
</script>
</body>
</html>
