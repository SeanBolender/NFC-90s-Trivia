<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>90s NFC Hunt - Game</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background-color: #f0f8ff; color: #1e3a8a; }
        .container { max-width: 650px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); }
        h2 { color: #008080; margin-top: 5px; }
        .question-box { margin: 25px 0; padding: 25px; border: 3px dashed #FFD700; border-radius: 8px; background-color: #fff9c4; }
        input[type="text"] { padding: 10px; margin: 10px 0; width: 80%; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 12px 25px; margin-top: 15px; background-color: #FF69B4; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .error { color: #b91c1c; font-weight: bold; }
        .success { color: #10b981; font-weight: bold; }
        #debug-info { 
            margin-top: 30px; 
            font-size: 12px; 
            color: #777; 
            border-top: 1px dashed #ccc; 
            padding-top: 10px; 
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="game-title">90s Time Warp Hunt</h1>
        <div id="game-content">Loading game...</div>
    </div>
    <div id="debug-info"></div>

    <script>
        // =======================================================================================
        // A. CONSTANTS & GAME DATA
        // =======================================================================================
        // NOTE: REPLACE 'XXXXXX' WITH YOUR ACTUAL DEPLOYMENT URL
        const POST_URL = "https://script.google.com/macros/s/XXXXXX/exec"; 
        
        const gameData = {
            sequence: ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8', 'Q9', 'Q10'],
            Q0: { clue: "Find the first NFC chip on the **NSYNC Cutout**." },
            Q1: {
                title: "Q1: üé∂ Pop Music",
                question: "Which group, known for hits like 'Bye Bye Bye,' was founded in 1995 but had its name taken from a famous attraction at Disney World?",
                correctAnswer: "NSYNC",
                clue: "Correct! Your next challenge is found by the **Game Boy**.",
                nextTag: "Q2"
            },
            Q2: {
                title: "Q2: üïπÔ∏è Gaming",
                question: "What highly addictive puzzle game, invented in the 80s, was included with the purchase of every original Game Boy console?",
                correctAnswer: "TETRIS",
                clue: "Awesome! The next chip is taped inside the **Michael Jordan TV Guide**.",
                nextTag: "Q3"
            },
            Q3: {
                title: "Q3: üèÄ Sports",
                question: "What iconic number did Michael Jordan wear for most of his career with the Chicago Bulls, and when he played on the 1992 Dream Team?",
                correctAnswer: "23",
                clue: "Slam dunk! Your next clue is near the lovable nerd's **favorite cheese snack**.",
                nextTag: "Q4"
            },
            Q4: {
                title: "Q4: üì∫ TV Sitcom",
                question: "What popular catchphrase, often followed by a backward shrug, was constantly repeated by the lovable nerd Steve Urkel on the show *Family Matters*?",
                correctAnswer: "DID I DO THAT?",
                clue: "That's right! Beam over to the captain's chair‚Äîthe biggest ship is calling for **Riker**.",
                nextTag: "Q5"
            },
            Q5: {
                title: "Q5: üññ Sci-Fi Trek",
                question: "STAR TREK: TNG: What is the full name of Captain Picard's first officer, who served for all seven seasons of *The Next Generation*?",
                correctAnswer: "WILLIAM T. RIKER",
                clue: "Engage! Look for the place where toys first came to life‚Äîthe **cowboy doll's foot**.",
                nextTag: "Q6"
            },
            Q6: {
                title: "Q6: üé¨ Animated Film",
                question: "What was the name of the first-ever feature-length film created entirely using computer-generated imagery (CGI)?",
                correctAnswer: "TOY STORY",
                clue: "To infinity and beyond! Now, find the spot where a famous Spanish dance became a worldwide hit on a **boombox**.",
                nextTag: "Q7"
            },
            Q7: {
                title: "Q7: üíÉ Dance Craze",
                question: "What Spanish one-hit wonder was remixed by the Bayside Boys and became a global dance craze in 1996, spending 14 weeks at #1?",
                correctAnswer: "MACARENA",
                clue: "Heeeeeyyy Macarena! Find the book by **R.L. Stine** that details a buzzing fear.",
                nextTag: "Q8"
            },
            Q8: {
                title: "Q8: üìö Children's Horror",
                question: "The book *Why I‚Äôm Afraid of Bees* belongs to the famous children‚Äôs horror series written by what author?",
                correctAnswer: "R.L. STINE",
                clue: "Be warned! The final question is waiting on the **back of the DVD player**.",
                nextTag: "Q9"
            },
            Q9: {
                title: "Q9: üìÄ Home Video Tech",
                question: "In 1998, a new format war began when the superior **DVD** format won out over its competitor, which was backed by Toshiba. What was the name of the losing format?",
                correctAnswer: "DIVX",
                clue: "Movie night success! For the finale, find the subtle **red object** in the next room.",
                nextTag: "Q10"
            },
            Q10: {
                title: "Q10: üëª Film Finale",
                question: "The shocking final reveal and famous line ('I see dead people') belong to which psychological thriller film?",
                correctAnswer: "THE SIXTH SENSE",
                clue: "üéâ CONGRATULATIONS! The code is **90SBOOM**. Go to the **freezer** for your grand prize!",
                nextTag: "WIN"
            },
            WIN: {
                title: "üéâ Hunt Complete!",
                content: "You mastered the 90s Time Warp! Proceed to the freezer with the code **90SBOOM**."
            }
        };

        // =======================================================================================
        // B. COOKIE / STORAGE FUNCTIONS (The new engine for reliability)
        // =======================================================================================
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }
        
        function eraseCookie(name) {
            document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        // =======================================================================================
        // C. GLOBAL VARIABLES (Reading state from cookies)
        // =======================================================================================
        const urlParams = new URLSearchParams(window.location.search);
        
        let teamName = getCookie('teamName'); 
        let currentStep = getCookie('currentStep') || 'Q0'; // Q0 is the default start state
        
        const tagID = urlParams.get('q'); // The tag the player just scanned (from the NFC URL)
        const gameContent = document.getElementById('game-content');
        const debugInfo = document.getElementById('debug-info');


        // =======================================================================================
        // D. CORE GAME LOGIC FUNCTIONS
        // =======================================================================================

        function isNextStep(scannedID) {
            const currentIndex = gameData.sequence.indexOf(currentStep);
            const nextIndex = currentIndex + 1;
            const expectedNextID = gameData.sequence[nextIndex];
            return scannedID === expectedNextID;
        }

        async function logAnswer(questionID, answer, correct) {
            const data = {
                Team: teamName,
                Question: questionID,
                Answer: answer,
                Correct: correct ? 'YES' : 'NO'
            };

            await fetch(POST_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        async function submitAnswer(questionID, correctAnswer) {
            const answerInput = document.getElementById('answer-input');
            const rawAnswer = answerInput ? answerInput.value.trim() : '';
            const submittedAnswer = rawAnswer.toUpperCase();
            const isCorrect = submittedAnswer === correctAnswer.toUpperCase();

            await logAnswer(questionID, submittedAnswer, isCorrect);

            if (isCorrect) {
                const nextTag = gameData[questionID].nextTag;
                const nextClue = gameData[questionID].clue;
                
                // Update the state in the cookie and local variable
                setCookie('currentStep', nextTag, 7); 
                currentStep = nextTag; 

                if (nextTag === 'WIN') {
                    showFinalMessage(gameData.WIN);
                } else {
                    showFeedback(true, nextClue);
                }
            } else {
                showFeedback(false, `‚ùå Incorrect! Try again, ${teamName}.`);
            }
        }

        // --- UI Display Functions ---
        function showQuestion(data, id) {
            gameContent.innerHTML = `
                <div class="question-box">
                    <h2>${data.title}</h2>
                    <p><strong>Team ${teamName}, what is your answer?</strong></p>
                    <p>${data.question}</p>
                    <input type="text" id="answer-input" placeholder="Type your answer here" />
                    <button onclick="submitAnswer('${id}', '${data.correctAnswer}')">Submit Answer</button>
                </div>
            `;
        }

        function showFeedback(isCorrect, message) {
            let feedbackHTML = isCorrect ? 
                `<h2 class="success">‚úÖ SUCCESS!</h2><p>${message}</p>` :
                `<h2 class="error">‚ùå Incorrect!</h2><p>${message}</p>`;

            gameContent.innerHTML = `<div class="question-box">${feedbackHTML}</div>`;
        }

        function showLockout(expectedID) {
            const expectedClue = gameData[currentStep].clue;
            const nextTag = gameData.sequence[gameData.sequence.indexOf(currentStep) + 1] || 'Q1';

            gameContent.innerHTML = `<div class="question-box error">
                <h2>üö´ HOLD IT, ${teamName}!</h2>
                <p>You must complete **${currentStep}** before scanning **${nextTag}**.</p>
                <p>Your current task location is: <strong>${expectedClue}</strong></p>
            </div>`;
        }

        function showFinalMessage(data) {
            gameContent.innerHTML = `
                <div class="question-box">
                    <h2 class="success">${data.title}</h2>
                    <p>${data.content}</p>
                    <button onclick="if(confirm('Are you sure you want to restart the hunt?')) { eraseCookie('teamName'); eraseCookie('currentStep'); window.location.href='start.html'; }">Restart Game</button>
                </div>
            `;
        }
    
        // =======================================================================================
        // E. GAME INITIALIZER (Runs on page load)
        // =======================================================================================
        function initializeGame() {
            // 1. Check if the team name is set (if not, send back to start.html)
            if (!teamName || teamName.length < 3) {
                window.location.href = 'start.html'; 
                return;
            }

            // Display debug info at the bottom of the page
            debugInfo.innerHTML = `
                <strong>GAME STATE (FOR DEBUG):</strong><br>
                Team Name: <strong>${teamName}</strong><br>
                Current Step (Last Answered): <strong>${currentStep}</strong><br>
                Tag Scanned: <strong>${tagID || 'N/A'}</strong>
            `;
            
            // 2. CHECK FOR STARTING STATE (Q0) OR REMINDER STATE
            if (!tagID) {
                // If no tag was scanned, remind the player of the current task.
                const lastAnsweredData = gameData[currentStep];
                showFeedback(true, lastAnsweredData.clue);
                return;
            }

            // 3. CHECK FOR CORRECT SCAN
            if (tagID) {
                processTag();
                return;
            }
        }

        // --- Final Execution ---
        initializeGame();
    </script>
</body>
</html>
